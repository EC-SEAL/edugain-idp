<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Seal Edugain IDP connector</a> &gt; <a href="index.source.html" class="el_package">eu.seal.idp.config</a> &gt; <span class="el_source">WebSecurityConfig.java</span></div><h1>WebSecurityConfig.java</h1><pre class="source lang-java linenums">package eu.seal.idp.config;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Timer;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.MultiThreadedHttpConnectionManager;
import org.apache.velocity.app.VelocityEngine;
import org.opensaml.saml2.metadata.provider.HTTPMetadataProvider;
import org.opensaml.saml2.metadata.provider.MetadataProvider;
import org.opensaml.saml2.metadata.provider.MetadataProviderException;
import org.opensaml.xml.parse.ParserPool;
import org.opensaml.xml.parse.StaticBasicParserPool;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.DisposableBean;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.DefaultResourceLoader;
import org.springframework.core.io.Resource;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.saml.SAMLAuthenticationProvider;
import org.springframework.security.saml.SAMLBootstrap;
import org.springframework.security.saml.SAMLDiscovery;
import org.springframework.security.saml.SAMLLogoutFilter;
import org.springframework.security.saml.SAMLLogoutProcessingFilter;
import org.springframework.security.saml.SAMLProcessingFilter;
import org.springframework.security.saml.SAMLRelayStateSuccessHandler;
import org.springframework.security.saml.SAMLWebSSOHoKProcessingFilter;
import org.springframework.security.saml.context.SAMLContextProviderImpl;
import org.springframework.security.saml.key.JKSKeyManager;
import org.springframework.security.saml.key.KeyManager;
import org.springframework.security.saml.log.SAMLDefaultLogger;
import org.springframework.security.saml.metadata.CachingMetadataManager;
import org.springframework.security.saml.metadata.ExtendedMetadata;
import org.springframework.security.saml.metadata.ExtendedMetadataDelegate;
import org.springframework.security.saml.metadata.MetadataDisplayFilter;
import org.springframework.security.saml.metadata.MetadataGenerator;
import org.springframework.security.saml.metadata.MetadataGeneratorFilter;
import org.springframework.security.saml.parser.ParserPoolHolder;
import org.springframework.security.saml.processor.HTTPArtifactBinding;
import org.springframework.security.saml.processor.HTTPPAOS11Binding;
import org.springframework.security.saml.processor.HTTPPostBinding;
import org.springframework.security.saml.processor.HTTPRedirectDeflateBinding;
import org.springframework.security.saml.processor.HTTPSOAP11Binding;
import org.springframework.security.saml.processor.SAMLBinding;
import org.springframework.security.saml.processor.SAMLProcessorImpl;
import org.springframework.security.saml.util.VelocityFactory;
import org.springframework.security.saml.websso.ArtifactResolutionProfile;
import org.springframework.security.saml.websso.ArtifactResolutionProfileImpl;
import org.springframework.security.saml.websso.SingleLogoutProfile;
import org.springframework.security.saml.websso.SingleLogoutProfileImpl;
import org.springframework.security.saml.websso.WebSSOProfile;
import org.springframework.security.saml.websso.WebSSOProfileConsumer;
import org.springframework.security.saml.websso.WebSSOProfileConsumerHoKImpl;
import org.springframework.security.saml.websso.WebSSOProfileConsumerImpl;
import org.springframework.security.saml.websso.WebSSOProfileECPImpl;
import org.springframework.security.saml.websso.WebSSOProfileImpl;
import org.springframework.security.saml.websso.WebSSOProfileOptions;
import org.springframework.security.web.DefaultSecurityFilterChain;
import org.springframework.security.web.FilterChainProxy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.access.channel.ChannelProcessingFilter;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler;
import org.springframework.security.web.authentication.logout.LogoutHandler;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.security.web.authentication.logout.SimpleUrlLogoutSuccessHandler;
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;
import org.springframework.security.web.csrf.CsrfFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import eu.seal.idp.service.impl.SAMLUserDetailsServiceImpl;
 
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(securedEnabled = true)
<span class="nc" id="L87">public class WebSecurityConfig extends WebSecurityConfigurerAdapter implements InitializingBean, DisposableBean {</span>
 
	private Timer backgroundTaskTimer;
	private MultiThreadedHttpConnectionManager multiThreadedHttpConnectionManager;

	public void init() {
<span class="nc" id="L93">		this.backgroundTaskTimer = new Timer(true);</span>
<span class="nc" id="L94">		this.multiThreadedHttpConnectionManager = new MultiThreadedHttpConnectionManager();</span>
<span class="nc" id="L95">	}</span>

	public void shutdown() {
<span class="nc" id="L98">		this.backgroundTaskTimer.purge();</span>
<span class="nc" id="L99">		this.backgroundTaskTimer.cancel();</span>
<span class="nc" id="L100">		this.multiThreadedHttpConnectionManager.shutdown();</span>
<span class="nc" id="L101">	}</span>
	
    @Autowired
    private SAMLUserDetailsServiceImpl samlUserDetailsServiceImpl;
     
    // Initialization of the velocity engine
    @Bean
    public VelocityEngine velocityEngine() {
<span class="nc" id="L109">        return VelocityFactory.getEngine();</span>
    }
 
    // XML parser pool needed for OpenSAML parsing
    @Bean(initMethod = &quot;initialize&quot;)
    public StaticBasicParserPool parserPool() {
<span class="nc" id="L115">        return new StaticBasicParserPool();</span>
    }
 
    @Bean(name = &quot;parserPoolHolder&quot;)
    public ParserPoolHolder parserPoolHolder() {
<span class="nc" id="L120">        return new ParserPoolHolder();</span>
    }
 
    // Bindings, encoders and decoders used for creating and parsing messages
    @Bean
    public HttpClient httpClient() {
<span class="nc" id="L126">        return new HttpClient(this.multiThreadedHttpConnectionManager);</span>
    }
 
    // SAML Authentication Provider responsible for validating of received SAML
    // messages
    @Bean
    public SAMLAuthenticationProvider samlAuthenticationProvider() {
<span class="nc" id="L133">        SAMLAuthenticationProvider samlAuthenticationProvider = new SAMLAuthenticationProvider();</span>
<span class="nc" id="L134">        samlAuthenticationProvider.setUserDetails(samlUserDetailsServiceImpl);</span>
<span class="nc" id="L135">        samlAuthenticationProvider.setForcePrincipalAsString(false);</span>
<span class="nc" id="L136">        return samlAuthenticationProvider;</span>
    }
 
    // Provider of default SAML Context
    @Bean
    public SAMLContextProviderImpl contextProvider() {
<span class="nc" id="L142">        return new SAMLContextProviderImpl();</span>
    }
 
    // Initialization of OpenSAML library
    @Bean
    public static SAMLBootstrap sAMLBootstrap() {
<span class="nc" id="L148">        return new SAMLBootstrap();</span>
    }
 
    // Logger for SAML messages and events
    @Bean
    public SAMLDefaultLogger samlLogger() {
<span class="nc" id="L154">        return new SAMLDefaultLogger();</span>
    }
 
    // SAML 2.0 WebSSO Assertion Consumer
    @Bean
    public WebSSOProfileConsumer webSSOprofileConsumer() {
<span class="nc" id="L160">        return new WebSSOProfileConsumerImpl();</span>
    }
 
    // SAML 2.0 Holder-of-Key WebSSO Assertion Consumer
    @Bean
    public WebSSOProfileConsumerHoKImpl hokWebSSOprofileConsumer() {
<span class="nc" id="L166">        return new WebSSOProfileConsumerHoKImpl();</span>
    }
 
    // SAML 2.0 Web SSO profile
    @Bean
    public WebSSOProfile webSSOprofile() {
<span class="nc" id="L172">        return new WebSSOProfileImpl();</span>
    }
 
    // SAML 2.0 Holder-of-Key Web SSO profile
    @Bean
    public WebSSOProfileConsumerHoKImpl hokWebSSOProfile() {
<span class="nc" id="L178">        return new WebSSOProfileConsumerHoKImpl();</span>
    }
 
    // SAML 2.0 ECP profile
    @Bean
    public WebSSOProfileECPImpl ecpprofile() {
<span class="nc" id="L184">        return new WebSSOProfileECPImpl();</span>
    }
 
    @Bean
    public SingleLogoutProfile logoutprofile() {
<span class="nc" id="L189">        return new SingleLogoutProfileImpl();</span>
    }
 
    // Central storage of cryptographic keys
    @Bean
    public KeyManager keyManager() {
<span class="nc" id="L195">        DefaultResourceLoader loader = new DefaultResourceLoader();</span>
<span class="nc" id="L196">        Resource storeFile = loader</span>
<span class="nc" id="L197">                .getResource(&quot;classpath:/saml/your_site_name.jks&quot;);</span>
<span class="nc" id="L198">        String storePass = System.getenv(&quot;SAML_KEYSTORE_PASS&quot;);</span>
<span class="nc" id="L199">        Map&lt;String, String&gt; passwords = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L200">        passwords.put(System.getenv(&quot;SAML_KEYSTORE_ID&quot;), System.getenv(&quot;SAML_KEYSTORE_PASS&quot;));</span>
<span class="nc" id="L201">        String defaultKey = System.getenv(&quot;SAML_KEYSTORE_ID&quot;);</span>
<span class="nc" id="L202">        return new JKSKeyManager(storeFile, storePass, passwords, defaultKey);</span>
    }
    
    @Bean
    public WebSSOProfileOptions defaultWebSSOProfileOptions() {
<span class="nc" id="L207">        WebSSOProfileOptions webSSOProfileOptions = new WebSSOProfileOptions();</span>
<span class="nc" id="L208">        webSSOProfileOptions.setIncludeScoping(false);</span>
<span class="nc" id="L209">        return webSSOProfileOptions;</span>
    }
 
    // Entry point to initialize authentication, default values taken from
    // properties file
    @Bean
    public SAMLWithRelayStateEntryPoint samlEntryPoint() {
<span class="nc" id="L216">    	SAMLWithRelayStateEntryPoint samlEntryPoint = new SAMLWithRelayStateEntryPoint();</span>
<span class="nc" id="L217">        samlEntryPoint.setDefaultProfileOptions(defaultWebSSOProfileOptions());</span>
<span class="nc" id="L218">        return samlEntryPoint;</span>
    }
    
    // Setup advanced info about metadata
    @Bean
    public ExtendedMetadata extendedMetadata() {
<span class="nc" id="L224">	    ExtendedMetadata extendedMetadata = new ExtendedMetadata();</span>
<span class="nc" id="L225">	    extendedMetadata.setIdpDiscoveryEnabled(false);</span>
<span class="nc" id="L226">	    extendedMetadata.setSigningAlgorithm(&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;);</span>
<span class="nc" id="L227">	    extendedMetadata.setSignMetadata(true);</span>
<span class="nc" id="L228">	    extendedMetadata.setEcpEnabled(true);</span>
<span class="nc" id="L229">	    return extendedMetadata;</span>
    }	
    
    // IDP Discovery Service
    @Bean
    public SAMLDiscovery samlIDPDiscovery() {
<span class="nc" id="L235">        SAMLDiscovery idpDiscovery = new SAMLDiscovery();</span>
<span class="nc" id="L236">        idpDiscovery.setIdpSelectionPath(&quot;/saml/discovery&quot;);</span>
<span class="nc" id="L237">        return idpDiscovery;</span>
    }
    
	@Bean
	@Qualifier(&quot;idp-ssocircle&quot;)
	public ExtendedMetadataDelegate ssoCircleExtendedMetadataProvider()
			throws MetadataProviderException {
<span class="nc" id="L244">		String idpSSOCircleMetadataURL = System.getenv(&quot;IDP_METADATA_URL&quot;);</span>
<span class="nc" id="L245">		HTTPMetadataProvider httpMetadataProvider = new HTTPMetadataProvider(</span>
<span class="nc" id="L246">				this.backgroundTaskTimer, httpClient(), idpSSOCircleMetadataURL);</span>
<span class="nc" id="L247">		httpMetadataProvider.setParserPool(parserPool());</span>
<span class="nc" id="L248">		ExtendedMetadataDelegate extendedMetadataDelegate = </span>
<span class="nc" id="L249">				new ExtendedMetadataDelegate(httpMetadataProvider, extendedMetadata());</span>
<span class="nc" id="L250">		extendedMetadataDelegate.setMetadataTrustCheck(true);</span>
<span class="nc" id="L251">		extendedMetadataDelegate.setMetadataRequireSignature(false);</span>
<span class="nc" id="L252">		backgroundTaskTimer.purge();</span>
<span class="nc" id="L253">		return extendedMetadataDelegate;</span>
	}

    // IDP Metadata configuration - paths to metadata of IDPs in circle of trust
    // is here
    // Do no forget to call iniitalize method on providers
    @Bean
    @Qualifier(&quot;metadata&quot;)
    public CachingMetadataManager metadata() throws MetadataProviderException {
<span class="nc" id="L262">        List&lt;MetadataProvider&gt; providers = new ArrayList&lt;MetadataProvider&gt;();</span>
<span class="nc" id="L263">        providers.add(ssoCircleExtendedMetadataProvider());</span>
<span class="nc" id="L264">        return new CachingMetadataManager(providers);</span>
    }
 
    // Filter automatically generates default SP metadata
    @Bean
    public MetadataGenerator metadataGenerator() {
<span class="nc" id="L270">        MetadataGenerator metadataGenerator = new MetadataGenerator();</span>
<span class="nc" id="L271">        metadataGenerator.setEntityId(&quot;saml-test&quot;);</span>
<span class="nc" id="L272">        metadataGenerator.setExtendedMetadata(extendedMetadata());</span>
<span class="nc" id="L273">        metadataGenerator.setIncludeDiscoveryExtension(false);</span>
<span class="nc" id="L274">        metadataGenerator.setKeyManager(keyManager()); </span>
<span class="nc" id="L275">        return metadataGenerator;</span>
    }
 
    // The filter is waiting for connections on URL suffixed with filterSuffix
    // and presents SP metadata there
    @Bean
    public MetadataDisplayFilter metadataDisplayFilter() {
<span class="nc" id="L282">        return new MetadataDisplayFilter();</span>
    }
     
    // Handler deciding where to redirect user after successful login
    @Bean
    public SAMLRelayStateSuccessHandler successRedirectHandler() {
<span class="nc" id="L288">    	SAMLRelayStateSuccessHandler successRedirectHandler =</span>
<span class="nc" id="L289">                new SAMLRelayStateSuccessHandler();</span>
<span class="nc" id="L290">        successRedirectHandler.setTargetUrlParameter(&quot;session&quot;);</span>
<span class="nc" id="L291">        successRedirectHandler.setDefaultTargetUrl(&quot;/as/callback&quot;);</span>
<span class="nc" id="L292">        return successRedirectHandler;</span>
    }
    
	// Handler deciding where to redirect user after failed login
    @Bean
    public SimpleUrlAuthenticationFailureHandler authenticationFailureHandler() {
<span class="nc" id="L298">	    	SimpleUrlAuthenticationFailureHandler failureHandler =</span>
<span class="nc" id="L299">	    			new SimpleUrlAuthenticationFailureHandler();</span>
<span class="nc" id="L300">	    	failureHandler.setUseForward(true);</span>
<span class="nc" id="L301">	    	failureHandler.setDefaultFailureUrl(&quot;/error&quot;);</span>
<span class="nc" id="L302">	    	return failureHandler;</span>
    }
     
    @Bean
    public SAMLWebSSOHoKProcessingFilter samlWebSSOHoKProcessingFilter() throws Exception {
<span class="nc" id="L307">        SAMLWebSSOHoKProcessingFilter samlWebSSOHoKProcessingFilter = new SAMLWebSSOHoKProcessingFilter();</span>
<span class="nc" id="L308">        samlWebSSOHoKProcessingFilter.setAuthenticationSuccessHandler(successRedirectHandler());</span>
<span class="nc" id="L309">        samlWebSSOHoKProcessingFilter.setAuthenticationManager(authenticationManager());</span>
<span class="nc" id="L310">        samlWebSSOHoKProcessingFilter.setAuthenticationFailureHandler(authenticationFailureHandler());</span>
<span class="nc" id="L311">        return samlWebSSOHoKProcessingFilter;</span>
    }
    
    // Processing filter for WebSSO profile messages
    @Bean
    public SAMLProcessingFilter samlWebSSOProcessingFilter() throws Exception {
<span class="nc" id="L317">        SAMLProcessingFilter samlWebSSOProcessingFilter = new SAMLProcessingFilter();</span>
<span class="nc" id="L318">        samlWebSSOProcessingFilter.setAuthenticationManager(authenticationManager());</span>
<span class="nc" id="L319">        samlWebSSOProcessingFilter.setAuthenticationSuccessHandler(successRedirectHandler());</span>
<span class="nc" id="L320">        samlWebSSOProcessingFilter.setAuthenticationFailureHandler(authenticationFailureHandler());</span>
<span class="nc" id="L321">        return samlWebSSOProcessingFilter;</span>
    }
     
    @Bean
    public MetadataGeneratorFilter metadataGeneratorFilter() {
<span class="nc" id="L326">        return new MetadataGeneratorFilter(metadataGenerator());</span>
    }
     
    // Handler for successful logout
    @Bean
    public SimpleUrlLogoutSuccessHandler successLogoutHandler() {
<span class="nc" id="L332">        SimpleUrlLogoutSuccessHandler successLogoutHandler = new SimpleUrlLogoutSuccessHandler();</span>
<span class="nc" id="L333">        successLogoutHandler.setDefaultTargetUrl(&quot;/&quot;);</span>
<span class="nc" id="L334">        return successLogoutHandler;</span>
    }
     
    // Logout handler terminating local session
    @Bean
    public SecurityContextLogoutHandler logoutHandler() {
<span class="nc" id="L340">        SecurityContextLogoutHandler logoutHandler = </span>
<span class="nc" id="L341">        		new SecurityContextLogoutHandler();</span>
<span class="nc" id="L342">        logoutHandler.setInvalidateHttpSession(true);</span>
<span class="nc" id="L343">        logoutHandler.setClearAuthentication(true);</span>
<span class="nc" id="L344">        return logoutHandler;</span>
    }
 
    // Filter processing incoming logout messages
    // First argument determines URL user will be redirected to after successful
    // global logout
    @Bean
    public SAMLLogoutProcessingFilter samlLogoutProcessingFilter() {
<span class="nc" id="L352">        return new SAMLLogoutProcessingFilter(successLogoutHandler(),</span>
<span class="nc" id="L353">                logoutHandler());</span>
    }
     
    // Overrides default logout processing filter with the one processing SAML
    // messages
    @Bean
    public SAMLLogoutFilter samlLogoutFilter() {
<span class="nc" id="L360">        return new SAMLLogoutFilter(successLogoutHandler(),</span>
<span class="nc" id="L361">                new LogoutHandler[] { logoutHandler() },</span>
<span class="nc" id="L362">                new LogoutHandler[] { logoutHandler() });</span>
    }
	
    // Bindings
    private ArtifactResolutionProfile artifactResolutionProfile() {
<span class="nc" id="L367">        final ArtifactResolutionProfileImpl artifactResolutionProfile = </span>
<span class="nc" id="L368">        		new ArtifactResolutionProfileImpl(httpClient());</span>
<span class="nc" id="L369">        artifactResolutionProfile.setProcessor(new SAMLProcessorImpl(soapBinding()));</span>
<span class="nc" id="L370">        return artifactResolutionProfile;</span>
    }
    
    @Bean
    public HTTPArtifactBinding artifactBinding(ParserPool parserPool, VelocityEngine velocityEngine) {
<span class="nc" id="L375">        return new HTTPArtifactBinding(parserPool, velocityEngine, artifactResolutionProfile());</span>
    }
 
    @Bean
    public HTTPSOAP11Binding soapBinding() {
<span class="nc" id="L380">        return new HTTPSOAP11Binding(parserPool());</span>
    }
    
    @Bean
    public HTTPPostBinding httpPostBinding() {
<span class="nc" id="L385">    		return new HTTPPostBinding(parserPool(), velocityEngine());</span>
    }
    
    @Bean
    public HTTPRedirectDeflateBinding httpRedirectDeflateBinding() {
<span class="nc" id="L390">    		return new HTTPRedirectDeflateBinding(parserPool());</span>
    }
    
    @Bean
    public HTTPSOAP11Binding httpSOAP11Binding() {
<span class="nc" id="L395">    	return new HTTPSOAP11Binding(parserPool());</span>
    }
    
    @Bean
    public HTTPPAOS11Binding httpPAOS11Binding() {
<span class="nc" id="L400">    		return new HTTPPAOS11Binding(parserPool());</span>
    }
    
    // Processor
	@Bean
	public SAMLProcessorImpl processor() {
<span class="nc" id="L406">		Collection&lt;SAMLBinding&gt; bindings = new ArrayList&lt;SAMLBinding&gt;();</span>
<span class="nc" id="L407">		bindings.add(httpRedirectDeflateBinding());</span>
<span class="nc" id="L408">		bindings.add(httpPostBinding());</span>
<span class="nc" id="L409">		bindings.add(artifactBinding(parserPool(), velocityEngine()));</span>
<span class="nc" id="L410">		bindings.add(httpSOAP11Binding());</span>
<span class="nc" id="L411">		bindings.add(httpPAOS11Binding());</span>
<span class="nc" id="L412">		return new SAMLProcessorImpl(bindings);</span>
	}
    
	/**
	 * Define the security filter chain in order to support SSO Auth by using SAML 2.0
	 * 
	 * @return Filter chain proxy
	 * @throws Exception
	 */
    @Bean
    public FilterChainProxy samlFilter() throws Exception {
<span class="nc" id="L423">        List&lt;SecurityFilterChain&gt; chains = new ArrayList&lt;SecurityFilterChain&gt;();</span>
<span class="nc" id="L424">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/login/**&quot;),</span>
<span class="nc" id="L425">                samlEntryPoint()));</span>
<span class="nc" id="L426">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/logout/**&quot;),</span>
<span class="nc" id="L427">                samlLogoutFilter()));</span>
<span class="nc" id="L428">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/metadata/**&quot;),</span>
<span class="nc" id="L429">                metadataDisplayFilter()));</span>
<span class="nc" id="L430">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/SSO/**&quot;),</span>
<span class="nc" id="L431">                samlWebSSOProcessingFilter()));</span>
<span class="nc" id="L432">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/SSOHoK/**&quot;),</span>
<span class="nc" id="L433">                samlWebSSOHoKProcessingFilter()));</span>
<span class="nc" id="L434">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/SingleLogout/**&quot;),</span>
<span class="nc" id="L435">                samlLogoutProcessingFilter()));</span>
<span class="nc" id="L436">        chains.add(new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/saml/discovery/**&quot;),</span>
<span class="nc" id="L437">                samlIDPDiscovery()));</span>
<span class="nc" id="L438">        return new FilterChainProxy(chains);</span>
    }
     
    /**
     * Returns the authentication manager currently used by Spring.
     * It represents a bean definition with the aim allow wiring from
     * other classes performing the Inversion of Control (IoC).
     * 
     * @throws  Exception 
     */
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
<span class="nc" id="L451">        return super.authenticationManagerBean();</span>
    }
     
    /**
     * Defines the web based security configuration.
     * 
     * @param   http It allows configuring web based security for specific http requests.
     * @throws  Exception 
     */
    @Override  
    protected void configure(HttpSecurity http) throws Exception {
<span class="nc" id="L462">        http</span>
<span class="nc" id="L463">            .httpBasic()</span>
<span class="nc" id="L464">                .authenticationEntryPoint(samlEntryPoint());      </span>
<span class="nc" id="L465">        http</span>
<span class="nc" id="L466">        		.addFilterBefore(metadataGeneratorFilter(), ChannelProcessingFilter.class)</span>
<span class="nc" id="L467">        		.addFilterAfter(samlFilter(), BasicAuthenticationFilter.class)</span>
<span class="nc" id="L468">        		.addFilterBefore(samlFilter(), CsrfFilter.class);</span>
<span class="nc" id="L469">        http        </span>
<span class="nc" id="L470">            .authorizeRequests()</span>
<span class="nc" id="L471">           		.antMatchers(&quot;*&quot;).permitAll()</span>
<span class="nc" id="L472">           		.antMatchers(&quot;/as/*&quot;).permitAll()</span>
<span class="nc" id="L473">           		.antMatchers(&quot;/start/**&quot;).permitAll()</span>
<span class="nc" id="L474">           		.antMatchers(&quot;/generate/*&quot;).permitAll()</span>
<span class="nc" id="L475">           		.antMatchers(&quot;/saml/**&quot;).permitAll()</span>
<span class="nc" id="L476">           		.antMatchers(&quot;/css/**&quot;).permitAll()</span>
<span class="nc" id="L477">           		.antMatchers(&quot;/img/**&quot;).permitAll()</span>
<span class="nc" id="L478">           		.antMatchers(&quot;/js/**&quot;).permitAll()</span>
<span class="nc" id="L479">           		.anyRequest().authenticated();</span>
<span class="nc" id="L480">        http</span>
<span class="nc" id="L481">        		.logout()</span>
<span class="nc" id="L482">        			.disable();	// The logout procedure is already handled by SAML filters.</span>
<span class="nc" id="L483">    }</span>
 
    /**
     * Sets a custom authentication provider.
     * @param   auth SecurityBuilder used to create an AuthenticationManager.
     * @throws  Exception 
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
<span class="nc" id="L492">        auth</span>
<span class="nc" id="L493">            .authenticationProvider(samlAuthenticationProvider());</span>
<span class="nc" id="L494">    }</span>

    @Override
    public void afterPropertiesSet() throws Exception {
<span class="nc" id="L498">        init();</span>
<span class="nc" id="L499">    }</span>

    @Override
    public void destroy() throws Exception {
<span class="nc" id="L503">        shutdown();</span>
<span class="nc" id="L504">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>