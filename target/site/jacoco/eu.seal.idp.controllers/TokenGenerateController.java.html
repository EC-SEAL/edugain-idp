<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TokenGenerateController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Seal Edugain IDP connector</a> &gt; <a href="index.source.html" class="el_package">eu.seal.idp.controllers</a> &gt; <span class="el_source">TokenGenerateController.java</span></div><h1>TokenGenerateController.java</h1><pre class="source lang-java linenums">package eu.seal.idp.controllers;

import eu.seal.idp.service.SealMetadataService;
import eu.seal.idp.service.HttpSignatureService;
import eu.seal.idp.service.KeyStoreService;
import eu.seal.idp.service.NetworkService;
import eu.seal.idp.service.impl.HttpSignatureServiceImpl;
import eu.seal.idp.service.impl.NetworkServiceImpl;
import eu.seal.idp.enums.TypeEnum;
import eu.seal.idp.model.pojo.AttributeSet;
import eu.seal.idp.model.pojo.AttributeSetStatus;
import eu.seal.idp.model.pojo.AttributeType;
import eu.seal.idp.model.pojo.DataSet;
import eu.seal.idp.model.pojo.DataStore;
import eu.seal.idp.model.pojo.UpdateDataRequest;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.security.Key;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.UnrecoverableKeyException;
import java.security.spec.InvalidKeySpecException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.httpclient.NameValuePair;
import org.slf4j.Logger;	
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * Controllers managing Seal Authentication Source, used in the log in and SSO Callback
 */
@Controller
public class TokenGenerateController {

<span class="nc" id="L48">	private final static Logger LOG = LoggerFactory.getLogger(TokenGenerateController.class);</span>

	private final NetworkService netServ;
	private final KeyStoreService keyServ;

	@Autowired
<span class="nc" id="L54">	public TokenGenerateController(KeyStoreService keyServ,</span>
			SealMetadataService metadataServ) throws KeyStoreException, NoSuchAlgorithmException, UnrecoverableKeyException, UnsupportedEncodingException, InvalidKeySpecException, IOException {
<span class="nc" id="L56">		this.keyServ = keyServ;</span>
<span class="nc" id="L57">		Key signingKey = this.keyServ.getSigningKey();</span>
<span class="nc" id="L58">		String fingerPrint = this.keyServ.getFingerPrint();</span>
<span class="nc" id="L59">		HttpSignatureService httpSigServ = new HttpSignatureServiceImpl(fingerPrint, signingKey);</span>
<span class="nc" id="L60">		this.netServ = new NetworkServiceImpl(httpSigServ);</span>
<span class="nc" id="L61">	}</span>
	
	/**
	 * Redirects an existing IDP request to the IDP 
	 */
	@RequestMapping(value = &quot;generate/start&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;text/plain&quot;)
	@ResponseBody
	public String startSession() throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L69">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
<span class="nc" id="L70">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L71">		String rsp = netServ.sendPostForm(sessionMngrUrl, &quot;/sm/startSession&quot;, requestParams, 1);</span>
<span class="nc" id="L72">		return rsp;	</span>
	}
	
	/**
	 * Redirects an existing IDP request to the IDP 
	 */	
	@RequestMapping(value = &quot;generate/generateToken&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;application/json&quot;)
	@ResponseBody
	public String generateToken(@RequestParam(value = &quot;session&quot;, required = true) String sessionID, @RequestParam(value = &quot;sender&quot;, required = true) String sender, @RequestParam(value = &quot;receiver&quot;, required = true) String receiver,RedirectAttributes redirectAttrs) throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L81">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
<span class="nc" id="L82">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L83">		requestParams.add(new NameValuePair(&quot;sessionId&quot;, sessionID));</span>
<span class="nc" id="L84">		requestParams.add(new NameValuePair(&quot;sender&quot;, sender));</span>
<span class="nc" id="L85">		requestParams.add(new NameValuePair(&quot;receiver&quot;, receiver));</span>
<span class="nc" id="L86">		String rsp = netServ.sendGet(sessionMngrUrl, &quot;/sm/generateToken&quot;, requestParams, 1);</span>
<span class="nc" id="L87">		return rsp;	</span>
	}
	
	/**
	 * Gets data from SM
	 */	
	@RequestMapping(value = &quot;generate/getSessionData&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;application/json&quot;)
	@ResponseBody
	public String getSM(@RequestParam(value = &quot;session&quot;, required = true) String sessionId, @RequestParam(value = &quot;sender&quot;, required = true) String sender, @RequestParam(value = &quot;receiver&quot;, required = true) String receiver,RedirectAttributes redirectAttrs) throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L96">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
<span class="nc" id="L97">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L98">		requestParams.add(new NameValuePair(&quot;sessionId&quot;, sessionId));</span>
		
<span class="nc" id="L100">		String rsp = netServ.sendGet(sessionMngrUrl, &quot;/sm/getSessionData&quot;,requestParams, 1);</span>
<span class="nc" id="L101">		return rsp;</span>
	}
	
	/**
	 * Store in sm from an existing token
	 */	
	@RequestMapping(value = &quot;generate/storeSM&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;application/json&quot;)
	@ResponseBody
	public String storeSM(@RequestParam(value = &quot;session&quot;, required = true) String sessionId, @RequestParam(value = &quot;sender&quot;, required = true) String sender, @RequestParam(value = &quot;receiver&quot;, required = true) String receiver,RedirectAttributes redirectAttrs) throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L110">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
		
<span class="nc" id="L112">		ObjectMapper mapper = new ObjectMapper();</span>
		
<span class="nc" id="L114">		DataStore datastore = new DataStore();</span>
<span class="nc" id="L115">		DataSet dataset = new DataSet();</span>
<span class="nc" id="L116">		String idpRequestPlain = &quot;{\&quot;id\&quot;:\&quot;_394a55a94873c15144a62678dafed1573503f4a6ab\&quot;,\&quot;type\&quot;:\&quot;Request\&quot;,\&quot;issuer\&quot;:\&quot;https:\\/\\/clave.sir2.rediris.es\\/module.php\\/saml\\/sp\\/saml2-acs.php\\/q2891006e_ea0002678\&quot;,\&quot;recipient\&quot;:null,\&quot;inResponseTo\&quot;:null,\&quot;loa\&quot;:null,\&quot;notBefore\&quot;:\&quot;2019-12-17T11:50:54Z\&quot;,\&quot;notAfter\&quot;:\&quot;2020-12-15T11:55:54Z\&quot;,\&quot;status\&quot;:{\&quot;code\&quot;:null,\&quot;subcode\&quot;:null,\&quot;message\&quot;:null},\&quot;attributes\&quot;:[{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonTargetedID \&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonTargetedID \&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#displayName\&quot;,\&quot;friendlyName\&quot;:\&quot;displayName\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#cn\&quot;,\&quot;friendlyName\&quot;:\&quot;cn\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#mail\&quot;,\&quot;friendlyName\&quot;:\&quot;mail\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonAffiliation\&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonAffiliation\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonScopedAffiliation\&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonScopedAffiliation\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/www.terena.org\\/activities\\/tf-emc2\\/docs\\/schac\\/schac-20110705-1.4.1.schema.txt#schacHomeOrganization\&quot;,\&quot;friendlyName\&quot;:\&quot;schacHomeOrganization\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;language\&quot;:null,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/www.terena.org\\/activities\\/tf-emc2\\/docs\\/schac\\/schac-20110705-1.4.1.schema.txt#schacHomeOrganizationType\&quot;,\&quot;friendlyName\&quot;:\&quot;schacHomeOrganizationType\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;language\&quot;:null,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null}],\&quot;properties\&quot;:{\&quot;SAML_RelayState\&quot;:\&quot;\&quot;,\&quot;SAML_RemoteSP_RequestId\&quot;:\&quot;_d951f7da6fd1cb7d2de7ab4df483098e\&quot;,\&quot;SAML_ForceAuthn\&quot;:true,\&quot;SAML_isPassive\&quot;:false,\&quot;SAML_NameIDFormat\&quot;:\&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:persistent\&quot;,\&quot;SAML_AllowCreate\&quot;:\&quot;true\&quot;}}&quot;;</span>
<span class="nc" id="L117">		AttributeType[] result = new AttributeType[2];</span>
<span class="nc" id="L118">		AttributeSetStatus atrSetStatus = new AttributeSetStatus();</span>
<span class="nc" id="L119">		Map &lt; String, String&gt; metadataProperties = new HashMap();</span>
<span class="nc" id="L120">		AttributeSet attrSet = new AttributeSet(&quot;id&quot;, TypeEnum.Response, &quot;edugainASms_001&quot;, &quot;CLms001&quot;, result, metadataProperties, sessionId, &quot;low&quot;, null, null, atrSetStatus);</span>
<span class="nc" id="L121">		String attributeSetString = mapper.writeValueAsString(datastore);</span>
		
<span class="nc" id="L123">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L124">		requestParams.add(new NameValuePair(&quot;sessionId&quot;, sessionId));</span>
<span class="nc" id="L125">		requestParams.add(new NameValuePair(&quot;sender&quot;, sender));</span>
<span class="nc" id="L126">		requestParams.add(new NameValuePair(&quot;receiver&quot;, receiver));</span>
		
		
		
<span class="nc" id="L130">		UpdateDataRequest updateReq = new UpdateDataRequest(sessionId, &quot;clientCallbackAddr&quot;, &quot;http://https://github.com/EC-SEAL&quot;);</span>
<span class="nc" id="L131">		UpdateDataRequest updateReqIdp = new UpdateDataRequest(sessionId, &quot;idpRequest&quot;, idpRequestPlain);</span>
<span class="nc" id="L132">		String rsp = netServ.sendPostBody(sessionMngrUrl, &quot;/sm/updateSessionData&quot;, updateReq, &quot;application/json&quot;, 1);</span>
<span class="nc" id="L133">		return rsp;</span>
	}
	
	/**
	 * Store in sm from an existing token
	 */	
	@RequestMapping(value = &quot;generate/storeDataset&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;application/json&quot;)
	@ResponseBody
	public String storeDS(@RequestParam(value = &quot;session&quot;, required = true) String sessionId, @RequestParam(value = &quot;sender&quot;, required = true) String sender, @RequestParam(value = &quot;receiver&quot;, required = true) String receiver,RedirectAttributes redirectAttrs) throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L142">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
		
<span class="nc" id="L144">		ObjectMapper mapper = new ObjectMapper();</span>
		
<span class="nc" id="L146">		DataStore datastore = new DataStore();</span>
<span class="nc" id="L147">		DataSet dataset = new DataSet();</span>
<span class="nc" id="L148">		String idpRequestPlain = &quot;{\&quot;id\&quot;:\&quot;_394a55a94873c15144a62678dafed1573503f4a6ab\&quot;,\&quot;type\&quot;:\&quot;Request\&quot;,\&quot;issuer\&quot;:\&quot;https:\\/\\/clave.sir2.rediris.es\\/module.php\\/saml\\/sp\\/saml2-acs.php\\/q2891006e_ea0002678\&quot;,\&quot;recipient\&quot;:null,\&quot;inResponseTo\&quot;:null,\&quot;loa\&quot;:null,\&quot;notBefore\&quot;:\&quot;2019-12-17T11:50:54Z\&quot;,\&quot;notAfter\&quot;:\&quot;2020-12-15T11:55:54Z\&quot;,\&quot;status\&quot;:{\&quot;code\&quot;:null,\&quot;subcode\&quot;:null,\&quot;message\&quot;:null},\&quot;attributes\&quot;:[{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonTargetedID \&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonTargetedID \&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#displayName\&quot;,\&quot;friendlyName\&quot;:\&quot;displayName\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#cn\&quot;,\&quot;friendlyName\&quot;:\&quot;cn\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#mail\&quot;,\&quot;friendlyName\&quot;:\&quot;mail\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonAffiliation\&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonAffiliation\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/software.internet2.edu\\/eduperson\\/internet2-mace-dir-eduperson-201602.html#eduPersonScopedAffiliation\&quot;,\&quot;friendlyName\&quot;:\&quot;eduPersonScopedAffiliation\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/www.terena.org\\/activities\\/tf-emc2\\/docs\\/schac\\/schac-20110705-1.4.1.schema.txt#schacHomeOrganization\&quot;,\&quot;friendlyName\&quot;:\&quot;schacHomeOrganization\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;language\&quot;:null,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null},{\&quot;name\&quot;:\&quot;https:\\/\\/www.terena.org\\/activities\\/tf-emc2\\/docs\\/schac\\/schac-20110705-1.4.1.schema.txt#schacHomeOrganizationType\&quot;,\&quot;friendlyName\&quot;:\&quot;schacHomeOrganizationType\&quot;,\&quot;encoding\&quot;:\&quot;UTF-8\&quot;,\&quot;language\&quot;:null,\&quot;isMandatory\&quot;:false,\&quot;values\&quot;:null}],\&quot;properties\&quot;:{\&quot;SAML_RelayState\&quot;:\&quot;\&quot;,\&quot;SAML_RemoteSP_RequestId\&quot;:\&quot;_d951f7da6fd1cb7d2de7ab4df483098e\&quot;,\&quot;SAML_ForceAuthn\&quot;:true,\&quot;SAML_isPassive\&quot;:false,\&quot;SAML_NameIDFormat\&quot;:\&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:persistent\&quot;,\&quot;SAML_AllowCreate\&quot;:\&quot;true\&quot;}}&quot;;</span>
<span class="nc" id="L149">		AttributeType[] result = new AttributeType[2];</span>
<span class="nc" id="L150">		AttributeSetStatus atrSetStatus = new AttributeSetStatus();</span>
<span class="nc" id="L151">		Map &lt; String, String&gt; metadataProperties = new HashMap();</span>
<span class="nc" id="L152">		AttributeSet attrSet = new AttributeSet(&quot;id&quot;, TypeEnum.Response, &quot;edugainASms_001&quot;, &quot;CLms001&quot;, result, metadataProperties, sessionId, &quot;low&quot;, null, null, atrSetStatus);</span>
<span class="nc" id="L153">		String attributeSetString = mapper.writeValueAsString(datastore);</span>
		
<span class="nc" id="L155">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L156">		requestParams.add(new NameValuePair(&quot;sessionId&quot;, sessionId));</span>
<span class="nc" id="L157">		requestParams.add(new NameValuePair(&quot;sender&quot;, sender));</span>
<span class="nc" id="L158">		requestParams.add(new NameValuePair(&quot;receiver&quot;, receiver));</span>
		
		
		
<span class="nc" id="L162">		UpdateDataRequest updateReq = new UpdateDataRequest(sessionId, &quot;datastore&quot;, attributeSetString);</span>
<span class="nc" id="L163">		UpdateDataRequest updateReqIdp = new UpdateDataRequest(sessionId, &quot;idpRequest&quot;, idpRequestPlain);</span>
<span class="nc" id="L164">		String rsp = netServ.sendPostBody(sessionMngrUrl, &quot;/sm/updateSessionData&quot;, updateReq, &quot;application/json&quot;, 1);</span>
<span class="nc" id="L165">		return rsp;</span>
	}
	
	/**
	 * 
	 */	
	@RequestMapping(value = &quot;generate/validateToken&quot;, method = {RequestMethod.POST, RequestMethod.GET}, produces = &quot;application/json&quot;)
	@ResponseBody
	public String validateToken(@RequestParam(value = &quot;msToken&quot;, required = true) String msToken, @RequestParam(value = &quot;sender&quot;, required = true) String sender, @RequestParam(value = &quot;receiver&quot;, required = true) String receiver,RedirectAttributes redirectAttrs) throws KeyStoreException, NoSuchAlgorithmException, IOException {
<span class="nc" id="L174">		String sessionMngrUrl = System.getenv(&quot;SESSION_MANAGER_URL&quot;);</span>
<span class="nc" id="L175">		List&lt;NameValuePair&gt; requestParams = new ArrayList&lt;NameValuePair&gt;();</span>
<span class="nc" id="L176">		requestParams.add(new NameValuePair(&quot;token&quot;, msToken));</span>
<span class="nc" id="L177">		ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L178">		String resp = netServ.sendGet(sessionMngrUrl, &quot;/sm/validateToken&quot;, requestParams, 1);</span>
<span class="nc" id="L179">		return resp;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>