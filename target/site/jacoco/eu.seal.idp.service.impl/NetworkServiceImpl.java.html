<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NetworkServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Seal Edugain IDP connector</a> &gt; <a href="index.source.html" class="el_package">eu.seal.idp.service.impl</a> &gt; <span class="el_source">NetworkServiceImpl.java</span></div><h1>NetworkServiceImpl.java</h1><pre class="source lang-java linenums">package eu.seal.idp.service.impl;

import com.fasterxml.jackson.databind.ObjectMapper;

import eu.seal.idp.service.HttpSignatureService;
import eu.seal.idp.service.NetworkService;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.security.KeyStoreException;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.UnrecoverableKeyException;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;
import java.util.UUID;
import org.apache.commons.httpclient.NameValuePair;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.util.StringUtils;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

/**
 *
 * @author nikos
 */
public class NetworkServiceImpl implements NetworkService {

    private HttpSignatureService sigServ;
<span class="nc" id="L46">    private final static Logger LOG = LoggerFactory.getLogger(NetworkServiceImpl.class);</span>

<span class="nc" id="L48">    public NetworkServiceImpl(HttpSignatureService sigServ) {</span>
<span class="nc" id="L49">        this.sigServ = sigServ;</span>
<span class="nc" id="L50">    }</span>

    @Override
    public String sendPostBody(String hostUrl, String uri, Object postBody, String contentType, int attempt) throws IOException, NoSuchAlgorithmException {

<span class="nc" id="L55">        Date date = new Date();</span>
<span class="nc" id="L56">        SimpleDateFormat formatter = new SimpleDateFormat(&quot;EEE, d MMM YYYY HH:mm:ss z&quot;, Locale.US);</span>
<span class="nc" id="L57">        formatter.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L58">        String nowDate = formatter.format(date);</span>
<span class="nc" id="L59">        String requestId = UUID.randomUUID().toString();</span>

<span class="nc" id="L61">        ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L62">        String updateString = mapper.writeValueAsString(postBody);</span>
<span class="nc" id="L63">        byte[] digest = MessageDigest.getInstance(&quot;SHA-256&quot;).digest(updateString.getBytes()); // post parameters are added as uri parameters not in the body when form-encoding</span>
<span class="nc" id="L64">        String host = hostUrl.replace(&quot;http://&quot;, &quot;&quot;).replace(&quot;https://&quot;, &quot;&quot;);</span>
        try {
<span class="nc" id="L66">            HttpHeaders requestHeaders = new HttpHeaders();</span>
<span class="nc" id="L67">            requestHeaders.add(&quot;authorization&quot;, sigServ.generateSignature(host, &quot;POST&quot;, &quot;/sm/updateSessionData&quot;, postBody, &quot;application/json;charset=UTF-8&quot;, requestId));</span>
<span class="nc" id="L68">            requestHeaders.add(&quot;host&quot;, hostUrl);</span>
<span class="nc" id="L69">            requestHeaders.add(&quot;original-date&quot;, nowDate);</span>
<span class="nc" id="L70">            requestHeaders.add(&quot;digest&quot;, &quot;SHA-256=&quot; + new String(org.tomitribe.auth.signatures.Base64.encodeBase64(MessageDigest.getInstance(&quot;SHA-256&quot;).digest(updateString.getBytes()))));</span>
<span class="nc" id="L71">            requestHeaders.add(&quot;x-request-id&quot;, requestId);</span>
<span class="nc" id="L72">            requestHeaders.setContentType(MediaType.APPLICATION_JSON);</span>
<span class="nc" id="L73">            requestHeaders.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L74">            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(hostUrl + uri);</span>
<span class="nc" id="L75">            RestTemplate restTemplate = new RestTemplate();</span>
<span class="nc" id="L76">            HttpEntity&lt;Object&gt; requestEntity = new HttpEntity&lt;&gt;(postBody, requestHeaders);</span>
            try {
<span class="nc" id="L78">                ResponseEntity&lt;String&gt; response</span>
<span class="nc" id="L79">                        = restTemplate.exchange(builder.toUriString(), HttpMethod.POST, requestEntity,</span>
<span class="nc" id="L80">                                String.class);</span>
<span class="nc" id="L81">                return response.getBody();</span>
<span class="nc" id="L82">            } catch (RestClientException e) {</span>
<span class="nc" id="L83">                LOG.info(&quot;request failed will retry&quot;);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                if (attempt &lt; 2) {</span>
<span class="nc" id="L85">                    return sendPostBody(hostUrl, uri, postBody, contentType, attempt + 1);</span>
                }
            }
<span class="nc" id="L88">        } catch (UnrecoverableKeyException e) {</span>
<span class="nc" id="L89">            LOG.info(e.getMessage());</span>
<span class="nc" id="L90">        } catch (KeyStoreException e) {</span>
<span class="nc" id="L91">            LOG.info(e.getMessage());</span>
<span class="nc" id="L92">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L93">            LOG.info(e.getMessage());</span>
        }
<span class="nc" id="L95">        return null;</span>
    }

    @Override
    public String sendPostForm(String hostUrl, String uri,
            List&lt;NameValuePair&gt; urlParameters, int attempt) throws IOException, NoSuchAlgorithmException {

<span class="nc" id="L102">        Map&lt;String, String&gt; map = new HashMap();</span>
<span class="nc" id="L103">        MultiValueMap&lt;String, String&gt; multiMap = new LinkedMultiValueMap&lt;&gt;();</span>

<span class="nc" id="L105">        urlParameters.stream().forEach(nameVal -&gt; {</span>
<span class="nc" id="L106">            map.put(nameVal.getName(), nameVal.getValue());</span>
<span class="nc" id="L107">            multiMap.add(nameVal.getName(), nameVal.getValue());</span>
<span class="nc" id="L108">        });</span>

<span class="nc" id="L110">        String requestId = UUID.randomUUID().toString();</span>
<span class="nc" id="L111">        RestTemplate restTemplate = new RestTemplate();</span>
<span class="nc" id="L112">        HttpHeaders headers = new HttpHeaders();</span>

<span class="nc" id="L114">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span>
<span class="nc" id="L115">        String host = hostUrl.replace(&quot;http://&quot;, &quot;&quot;).replace(&quot;https://&quot;, &quot;&quot;);</span>

        try {
<span class="nc" id="L118">            headers.add(&quot;authorization&quot;, sigServ.generateSignature(host, &quot;POST&quot;, uri, null, &quot;application/x-www-form-urlencoded&quot;, requestId));</span>
<span class="nc" id="L119">            Date date = new Date();</span>
            byte[] digestBytes;
            //only when the request is json encoded are the post params added to the body of the request
            // else they eventually become encoded to the url
<span class="nc" id="L123">            digestBytes = MessageDigest.getInstance(&quot;SHA-256&quot;).digest(&quot;&quot;.getBytes());</span>
<span class="nc" id="L124">            LOG.info(&quot;DigestBytes: &quot; + digestBytes);</span>
<span class="nc" id="L125">            addHeaders(headers, host, date, digestBytes, uri, requestId);</span>

<span class="nc" id="L127">        } catch (IOException | KeyStoreException | NoSuchAlgorithmException | UnrecoverableKeyException e) {</span>
<span class="nc" id="L128">            LOG.error(&quot;could not generate signature!!&quot;);</span>
<span class="nc" id="L129">            LOG.error(e.getMessage());</span>
        }

<span class="nc" id="L132">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; request = new HttpEntity&lt;&gt;(multiMap, headers);</span>
        try {
<span class="nc" id="L134">            ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(</span>
<span class="nc" id="L135">                    hostUrl + uri, request, String.class);</span>
<span class="nc" id="L136">            return response.getBody();</span>
<span class="nc" id="L137">        } catch (RestClientException e) {</span>
<span class="nc" id="L138">            LOG.error(&quot;request failed will retry&quot; + e.getMessage());</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (attempt &lt; 2) {</span>
<span class="nc" id="L140">                return sendPostForm(hostUrl, uri,</span>
<span class="nc" id="L141">                        urlParameters, attempt + 1);</span>
            }
        }

<span class="nc" id="L145">        return null;</span>
    }

    @Override
    public String sendGet(String hostUrl, String uri,
            List&lt;NameValuePair&gt; urlParameters, int attempt) throws IOException, NoSuchAlgorithmException {

<span class="nc" id="L152">        Date date = new Date();</span>
<span class="nc" id="L153">        SimpleDateFormat formatter = new SimpleDateFormat(&quot;EEE, d MMM YYYY HH:mm:ss z&quot;, Locale.US);</span>
<span class="nc" id="L154">        formatter.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L155">        String nowDate = formatter.format(date);</span>
<span class="nc" id="L156">        String requestId = UUID.randomUUID().toString();</span>
<span class="nc" id="L157">        UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(hostUrl + uri);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (urlParameters != null) {</span>
<span class="nc" id="L159">            Map&lt;String, String&gt; map = new HashMap();</span>
<span class="nc" id="L160">            urlParameters.stream().forEach(nameVal -&gt; {</span>
<span class="nc" id="L161">                map.put(nameVal.getName(), nameVal.getValue());</span>
<span class="nc" id="L162">                builder.queryParam(nameVal.getName(), nameVal.getValue());</span>
<span class="nc" id="L163">            });</span>
        }

<span class="nc" id="L166">        RestTemplate restTemplate = new RestTemplate();</span>
<span class="nc" id="L167">        HttpHeaders requestHeaders = new HttpHeaders();</span>
<span class="nc" id="L168">        String host = hostUrl.replace(&quot;http://&quot;, &quot;&quot;).replace(&quot;https://&quot;, &quot;&quot;);</span>
<span class="nc" id="L169">        byte[] digest = MessageDigest.getInstance(&quot;SHA-256&quot;).digest(&quot;&quot;.getBytes());</span>
        try {
<span class="nc" id="L171">            requestHeaders.add(&quot;host&quot;, host);</span>
<span class="nc" id="L172">            requestHeaders.add(&quot;original-date&quot;, nowDate);</span>
<span class="nc" id="L173">            requestHeaders.add(&quot;digest&quot;, &quot;SHA-256=&quot; + new String(org.tomitribe.auth.signatures.Base64.encodeBase64(digest)));</span>
<span class="nc" id="L174">            requestHeaders.add(&quot;x-request-id&quot;, requestId);</span>
<span class="nc" id="L175">            URL url = new URL(builder.toUriString());</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">            String getURL = StringUtils.isEmpty(url.getQuery())?url.getPath():url.getPath() + &quot;?&quot; + url.getQuery();</span>
            
<span class="nc" id="L179">            requestHeaders.add(&quot;authorization&quot;, sigServ.generateSignature(host, &quot;GET&quot;, getURL, null, &quot;application/x-www-form-urlencoded&quot;, requestId));</span>
        
<span class="nc" id="L181">        } catch (IOException e) {</span>
<span class="nc" id="L182">            LOG.error(&quot;could not generate signature!!&quot;);</span>
<span class="nc" id="L183">            LOG.error(e.getMessage());</span>
<span class="nc" id="L184">        } catch (UnrecoverableKeyException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L186">			e.printStackTrace();</span>
<span class="nc" id="L187">		} catch (KeyStoreException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L189">			e.printStackTrace();</span>
		}

<span class="nc" id="L192">        HttpEntity entity = new HttpEntity(requestHeaders);</span>
        try {
<span class="nc" id="L194">            ResponseEntity&lt;String&gt; response = restTemplate.exchange(</span>
<span class="nc" id="L195">                    builder.toUriString(), HttpMethod.GET, entity, String.class);</span>
<span class="nc" id="L196">            return response.getBody();</span>
<span class="nc" id="L197">        } catch (RestClientException e) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (attempt &lt; 2) {</span>
<span class="nc" id="L199">                return sendGet(hostUrl, uri,</span>
<span class="nc" id="L200">                        urlParameters, attempt + 1);</span>
            }
        }
<span class="nc" id="L203">        return null;</span>

    }

    private void addHeaders(HttpHeaders headers, String host, Date date, byte[] digestBytes, String uri, String requestId) throws NoSuchAlgorithmException {
<span class="nc" id="L208">        SimpleDateFormat formatter = new SimpleDateFormat(&quot;EEE, d MMM YYYY HH:mm:ss z&quot;, Locale.US);</span>
<span class="nc" id="L209">        formatter.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L210">        String nowDate = formatter.format(date);</span>
<span class="nc" id="L211">        headers.add(&quot;host&quot;, host);</span>
<span class="nc" id="L212">        headers.add(&quot;original-date&quot;, nowDate);</span>
<span class="nc" id="L213">        headers.add(&quot;digest&quot;, &quot;SHA-256=&quot; + new String(org.tomitribe.auth.signatures.Base64.encodeBase64(digestBytes)));</span>
<span class="nc" id="L214">        headers.add(&quot;x-request-id&quot;, requestId);</span>

<span class="nc" id="L216">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>